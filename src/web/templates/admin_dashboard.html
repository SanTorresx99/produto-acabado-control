<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>OPS e Apontamento - User Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        tr.clickable-row:hover {
            background-color: #f1f1f1;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-5">
        <h2 class="text-center fw-bold">OPS e Apontamento - User Admin</h2>

        <form class="mt-4 d-flex flex-wrap justify-content-center gap-3" id="form-filtros">
            <div>
                <label class="form-label">Data:</label>
                <input type="date" class="form-control" name="data" id="data" required>
            </div>

            <div>
                <label class="form-label">Subesp√©cie:</label>
                <select class="form-select" name="subespecie" id="subespecie">
                    <option value="">-- todas --</option>
                </select>
            </div>

            <div class="align-self-end">
                <button type="submit" class="btn btn-primary">Buscar</button>
            </div>
        </form>

        <div class="table-responsive mt-5" id="resultado" style="display:none;">
            <h5>Resultado:</h5>
            <table class="table table-striped table-bordered" id="tabela-ops">
                <thead class="table-dark">
                    <tr id="cabecalho-tabela"></tr>
                </thead>
                <tbody id="corpo-tabela"></tbody>
            </table>
        </div>
    </div>

    <script>
        const form = document.getElementById('form-filtros');
        const subespecieSelect = document.getElementById('subespecie');
        const dataInput = document.getElementById('data');
        const divResultado = document.getElementById('resultado');
        const tabelaCabecalho = document.getElementById('cabecalho-tabela');
        const tabelaCorpo = document.getElementById('corpo-tabela');

        dataInput.valueAsDate = new Date();

        async function carregarSubespecies() {
            const data = dataInput.value;
            const url = `/api/filtros?data=${data}`;
            const res = await fetch(url);
            const dados = await res.json();

            const subespecieAtual = subespecieSelect.value;
            subespecieSelect.innerHTML = '<option value="">-- todas --</option>';
            dados.subespecies.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.textContent = s;
                if (s === subespecieAtual) opt.selected = true;
                subespecieSelect.appendChild(opt);
            });
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = dataInput.value;
            const subespecie = subespecieSelect.value;

            const res = await fetch(`/api/ops?data=${data}&subespecie=${encodeURIComponent(subespecie)}`);
            const dados = await res.json();

            const registros = dados.ops || [];
            divResultado.style.display = registros.length > 0 ? 'block' : 'none';

            if (registros.length === 0) {
                tabelaCabecalho.innerHTML = '';
                tabelaCorpo.innerHTML = '<tr><td colspan="99" class="text-center">Nenhum registro encontrado.</td></tr>';
                return;
            }

            const colunas = Object.keys(registros[0]);
            tabelaCabecalho.innerHTML = colunas.map(col => {
                if (col === "QTD_REGISTRADA") return '<th class="text-center">Qtd. Registrada</th>';
                return `<th>${col.replace(/_/g, ' ')}</th>`;
            }).join('');

            tabelaCorpo.innerHTML = registros.map(row => {
                const codigoOP = row["CODIGO_OP"];
                const linha = colunas.map(col => {
                    return `<td class="text-center">${row[col]}</td>`;
                }).join('');
                return `<tr class="clickable-row" onclick="window.location='/op/${codigoOP}'">${linha}</tr>`;
            }).join('');
        });

        dataInput.addEventListener('change', carregarSubespecies);
        carregarSubespecies();
    </script>
</body>
</html>
